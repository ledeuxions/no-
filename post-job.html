<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>공고 등록</title>
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,sans-serif;max-width:960px;margin:24px auto;padding:0 16px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    input,select,textarea{width:100%;padding:10px;border:1px solid #ddd;border-radius:12px}
    button{padding:10px 16px;border-radius:12px;border:0;background:#2563eb;color:#fff;cursor:pointer}
    button[disabled]{opacity:.6;cursor:default}
    .card{background:#fff;border:1px solid #eee;border-radius:16px;padding:16px}
    .muted{color:#666;font-size:12px}
  </style>
</head>
<body>
  <h1>공고 등록</h1>
  <p class="muted">로그인한 사용자만 제출할 수 있습니다. (Netlify Identity)</p>

  <div id="auth-info" class="card" style="margin:12px 0"></div>

  <form id="postJobForm" class="card">
    <div class="row">
      <div>
        <label>제목 *</label>
        <input name="title" required />
      </div>
      <div>
        <label>회사/팀명</label>
        <input name="company" />
      </div>
    </div>

    <div class="row">
      <div>
        <label>분류 *</label>
        <select name="category" required>
          <option value="">선택</option>
          <option>개발</option><option>디자인</option><option>영상/콘텐츠</option>
          <option>마케팅/세일즈</option><option>운영/CS</option>
        </select>
      </div>
      <div>
        <label>지역</label>
        <select name="location">
          <option value="">온라인/미정</option><option>서울</option><option>부산</option><option>대구</option><option>경기</option><option>온라인</option>
        </select>
      </div>
    </div>

    <div class="row">
      <div>
        <label>보상 유형 *</label>
        <select name="reward_type" required>
          <option value="">선택</option>
          <option value="share">수익쉐어</option>
          <option value="bounty">건당 보너스</option>
          <option value="hybrid">하이브리드</option>
        </select>
      </div>
      <div>
        <label>수익쉐어 %/조건(선택)</label>
        <input name="share" placeholder="예: 매출의 10% (3개월)" />
      </div>
    </div>

    <div class="row">
      <div>
        <label>캡(선택)</label>
        <input name="cap" placeholder="예: 최대 300만원" />
      </div>
      <div>
        <label>지급 트리거(선택)</label>
        <input name="trigger" placeholder="예: 정산 완료 시" />
      </div>
    </div>

    <div>
      <label>연락처/링크 *</label>
      <input name="contact" required placeholder="이메일 또는 지원 링크" />
    </div>

    <div>
      <label>상세 설명 *</label>
      <textarea name="desc" rows="8" required placeholder="업무 내용, 기간, 필요 역량, 협업 방식, 검수/정산 방식 등"></textarea>
    </div>

    <div style="display:flex;gap:8px;justify-content:flex-end">
      <a href="/" class="muted" style="align-self:center;text-decoration:none">홈으로</a>
      <button id="btnSubmit" type="submit">등록</button>
    </div>
    <p class="muted">※ 무급 상시근로 대체성 공고는 승인되지 않습니다.</p>
  </form>

  <script>
  (function(){
    const info = document.getElementById('auth-info');
    function renderAuth(){
      const id = window.netlifyIdentity; const user = id && id.currentUser ? id.currentUser() : null;
      if(user){ info.innerHTML = '로그인: <b>' + (user.email||'') + '</b>'; }
      else { info.innerHTML = '로그인이 필요합니다. 상단의 로그인 버튼 또는 이 페이지에서 팝업으로 로그인하세요.'; }
    }
    document.addEventListener('DOMContentLoaded', renderAuth);
    if(window.netlifyIdentity){ window.netlifyIdentity.on('login', ()=>location.reload()); }

    const form = document.getElementById('postJobForm');
    const btn  = document.getElementById('btnSubmit');
    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const id = window.netlifyIdentity; const user = id && id.currentUser ? id.currentUser() : null;
      if(!user){ id && id.open('login'); alert('로그인 후 이용해주세요.'); return; }
      const data = Object.fromEntries(new FormData(form).entries());
      const required=['title','category','reward_type','contact','desc'];
      for(const k of required){ if(!String(data[k]||'').trim()){ alert('필수 항목 누락: '+k); return; } }
      btn.disabled=true; btn.textContent='등록 중…';
      try{
        const token = await user.jwt();
        const r = await fetch('/.netlify/functions/submit-job',{
          method:'POST', headers:{'Content-Type':'application/json','Authorization':'Bearer '+token},
          body: JSON.stringify(data)
        });
        const res = await r.json().catch(()=>({}));
        if(!r.ok) throw new Error(res.message||'등록 실패');
        alert('등록 요청이 접수되었습니다. 검수 후 노출됩니다.');
        form.reset();
      }catch(err){ alert(err.message||'오류'); }
      finally{ btn.disabled=false; btn.textContent='등록'; }
    });
  })();
  </script>
</body>
</html>
