<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NO열정페이.COM 관리자</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .btn { @apply inline-flex items-center justify-center rounded-md px-3 py-2 text-sm font-semibold shadow-sm; }
    .btn-primary { @apply bg-indigo-600 text-white hover:bg-indigo-700; }
    .btn-danger { @apply bg-red-600 text-white hover:bg-red-700; }
    .btn-ghost { @apply border bg-white text-gray-900 hover:bg-gray-50; }
    #toast {
      @apply fixed top-5 right-5 hidden rounded-md bg-gray-900 px-4 py-3 text-white shadow-lg;
      animation: slide-in 0.3s ease-out, slide-out 0.3s ease-in 2.7s forwards;
    }
    @keyframes slide-in { from { transform: translateX(100%); } to { transform: translateX(0); } }
    @keyframes slide-out { from { transform: translateX(0); } to { transform: translateX(100%); } }
  </style>
</head>
<body class="bg-gray-50 text-gray-900">
  <div class="flex h-screen">
    <!-- Sidebar -->
    <aside class="w-64 flex-shrink-0 bg-white border-r">
      <div class="p-4">
        <h1 class="text-xl font-bold">NO열정페이.COM</h1>
      </div>
      <nav class="mt-4 px-2 space-y-1">
        <a href="#" class="flex items-center px-2 py-2 text-sm font-medium rounded-md bg-gray-100 text-gray-900">
          FAQ 관리
        </a>
      </nav>
      <div class="absolute bottom-0 w-64 p-4 border-t">
        <a href="/" class="text-sm text-gray-600 hover:text-indigo-600">← 사이트로 돌아가기</a>
      </div>
    </aside>

    <!-- Main content -->
    <main class="flex-1 overflow-y-auto">
      <div class="p-6">
        <section id="faqs-section">
          <div class="flex items-center justify-between mb-4">
            <h2 class="text-2xl font-bold">FAQ 관리</h2>
            <div>
              <button id="btn-add-faq" class="btn btn-ghost mr-2">새 FAQ 추가</button>
              <button id="btn-save-faq" class="btn btn-primary">저장</button>
            </div>
          </div>
          <div id="faq-list" class="space-y-4">
            <!-- FAQ items will be populated here -->
          </div>
        </section>
      </div>
    </main>
  </div>

  <!-- Toast Notification -->
  <div id="toast"></div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const faqList = document.getElementById('faq-list');
      const btnAddFaq = document.getElementById('btn-add-faq');
      const btnSaveFaq = document.getElementById('btn-save-faq');
      const toast = document.getElementById('toast');

      let originalFaqData = [];

      // --- Toast Notification ---
      function showToast(message, isError = false) {
        toast.textContent = message;
        toast.className = `fixed top-5 right-5 rounded-md px-4 py-3 text-white shadow-lg ${isError ? 'bg-red-600' : 'bg-gray-900'}`;
        toast.style.display = 'block';
        setTimeout(() => {
          toast.style.display = 'none';
        }, 3000);
      }

      // --- FAQ Item Template ---
      function createFaqItem(item = { q: '', a: '' }, index) {
        const div = document.createElement('div');
        div.className = 'bg-white p-4 rounded-lg shadow border';
        div.innerHTML = `
          <div class="flex justify-between items-center mb-2">
            <label class="block text-sm font-medium text-gray-700">질문 (Q)</label>
            <button class="btn-remove-faq text-red-500 hover:text-red-700 text-sm">삭제</button>
          </div>
          <input type="text" value="${item.q}" class="faq-q w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm mb-2">
          <label class="block text-sm font-medium text-gray-700 mt-2">답변 (A)</label>
          <textarea class="faq-a w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" rows="3">${item.a}</textarea>
        `;
        div.querySelector('.btn-remove-faq').addEventListener('click', () => div.remove());
        return div;
      }

      // --- Load FAQs ---
      async function loadFaqs() {
        try {
          const response = await fetch('/faq.json?t=' + new Date().getTime()); // Cache busting
          if (!response.ok) throw new Error('FAQ 데이터를 불러오는 데 실패했습니다.');
          const data = await response.json();
          originalFaqData = data.items;
          faqList.innerHTML = '';
          originalFaqData.forEach((item, index) => {
            faqList.appendChild(createFaqItem(item, index));
          });
        } catch (error) {
          showToast(error.message, true);
        }
      }

      // --- Add New FAQ ---
      btnAddFaq.addEventListener('click', () => {
        faqList.appendChild(createFaqItem(undefined, faqList.children.length));
        window.scrollTo(0, document.body.scrollHeight);
      });

      // --- Save FAQs ---
      btnSaveFaq.addEventListener('click', async () => {
        const newItems = Array.from(faqList.children).map(div => {
          const q = div.querySelector('.faq-q').value.trim();
          const a = div.querySelector('.faq-a').value.trim();
          return { q, a };
        }).filter(item => item.q && item.a);

        const newFaqData = { items: newItems };
        
        btnSaveFaq.disabled = true;
        btnSaveFaq.textContent = '저장 중...';

        try {
          const response = await fetch('/.netlify/functions/update-faq', {
            method: 'POST',
            body: JSON.stringify(newFaqData, null, 2)
          });
          
          const result = await response.json();

          if (!response.ok) {
            throw new Error(result.message || '저장에 실패했습니다.');
          }
          
          showToast('FAQ가 성공적으로 저장되었습니다.');
          await loadFaqs(); // Reload to confirm changes
        } catch (error) {
          showToast(error.message, true);
        } finally {
          btnSaveFaq.disabled = false;
          btnSaveFaq.textContent = '저장';
        }
      });

      // Initial Load
      loadFaqs();
    });
  </script>
</body>
</html>
